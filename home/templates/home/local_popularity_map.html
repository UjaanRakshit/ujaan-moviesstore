{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Local Popularity Map</h1>
            <p class="lead">Discover popular movies in your area</p>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
            <div class="alert alert-info mt-3" id="location-status">
                <i class="fas fa-info-circle"></i> Click the button below to center the map on your current location.
            </div>
            <button id="locate-btn" class="btn btn-primary mt-2">
                <i class="fas fa-location-arrow"></i> Use My Location
            </button>
        </div>
    </div>
</div>

<script>
    // Server-provided country popularity (fallback to empty object)
    window.COUNTRY_POPULARITY = {{ country_popularity|default:'{}'|safe }};
    let map;
    let userMarker;

    function getColor(d) {
        return d > 100 ? '#800026' :
               d > 50  ? '#BD0026' :
               d > 20  ? '#E31A1C' :
               d > 10  ? '#FC4E2A' :
               d > 5   ? '#FD8D3C' :
               d > 0   ? '#FEB24C' :
                         '#FFFFFF';
    }

    function styleFeature(feature) {
        const iso3 = feature.getProperty && (feature.getProperty('ISO_A3') || feature.getProperty('ISO_A2') || feature.getProperty('iso_a3') || feature.getProperty('adm0_a3'));
        const name = feature.getProperty && (feature.getProperty('ADMIN') || feature.getProperty('NAME') || feature.getProperty('name'));
        const key = iso3 || name;
        const value = window.COUNTRY_POPULARITY && window.COUNTRY_POPULARITY[key] ? window.COUNTRY_POPULARITY[key] : 0;

        return {
            fillColor: getColor(value),
            strokeColor: '#333',
            strokeWeight: 1,
            fillOpacity: value ? 0.65 : 0.15,
            clickable: true,
        };
    }

    // Initialize the map
    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 3,
            center: { lat: 20, lng: 0 },
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true,
        });

        const infoWindow = new google.maps.InfoWindow();

        // Load GeoJSON of countries
        const geoJsonUrl = 'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson';
        fetch(geoJsonUrl)
            .then(res => res.json())
            .then(data => {
                console.log('COUNTRY_POPULARITY (from server):', window.COUNTRY_POPULARITY);
                console.log('Loaded GeoJSON features:', data.features && data.features.length);

                map.data.addGeoJson(data);
                map.data.setStyle(styleFeature);

                map.data.addListener('mouseover', function(event) {
                    map.data.overrideStyle(event.feature, { strokeWeight: 2, fillOpacity: 0.85 });
                    const name = event.feature.getProperty('ADMIN') || event.feature.getProperty('NAME') || event.feature.getProperty('name');
                    const iso3 = event.feature.getProperty('ISO_A3') || event.feature.getProperty('iso_a3') || event.feature.getProperty('ISO_A2');
                    const key = iso3 || name;
                    const value = window.COUNTRY_POPULARITY && window.COUNTRY_POPULARITY[key] ? window.COUNTRY_POPULARITY[key] : 0;
                    infoWindow.setContent(`<div style="min-width:140px;"><strong>${name || 'Unknown'}</strong><br>Popularity: <strong>${value}</strong></div>`);
                    if (event.latLng) { infoWindow.setPosition(event.latLng); infoWindow.open(map); }
                });

                map.data.addListener('mouseout', function(event) {
                    map.data.revertStyle();
                    infoWindow.close();
                });

                map.data.addListener('click', function(event) {
                    const name = event.feature.getProperty('ADMIN') || event.feature.getProperty('NAME') || event.feature.getProperty('name');
                    const iso3 = event.feature.getProperty('ISO_A3') || event.feature.getProperty('iso_a3') || event.feature.getProperty('ISO_A2');
                    const key = iso3 || name;
                    const value = window.COUNTRY_POPULARITY && window.COUNTRY_POPULARITY[key] ? window.COUNTRY_POPULARITY[key] : 0;
                    infoWindow.setContent(`<div style="min-width:200px;"><h6 style="margin:0">${name || 'Unknown'}</h6><p style="margin:0.25rem 0 0 0">Popularity: <strong>${value}</strong></p></div>`);
                    if (event.latLng) { infoWindow.setPosition(event.latLng); infoWindow.open(map); }
                });

                // Add legend
                const legend = document.createElement('div');
                legend.id = 'map-legend';
                legend.style.background = 'white';
                legend.style.padding = '8px';
                legend.style.border = '1px solid #ddd';
                legend.innerHTML = '<h6 style="margin:0 0 6px 0">Popularity</h6>';
                const grades = [0,1,6,11,21,51,101];
                for (let i=0;i<grades.length;i++){
                    const from = grades[i];
                    const color = getColor(from+1);
                    const label = from===0? '0' : `${from}${grades[i+1]?('â€“'+(grades[i+1]-1)):'+'}`;
                    const item = document.createElement('div');
                    item.innerHTML = `<span style="display:inline-block;width:18px;height:12px;background:${color};margin-right:8px;border:1px solid #999;"></span>${label}`;
                    legend.appendChild(item);
                }
                map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
            })
            .catch(err => console.error('Failed to load GeoJSON:', err));

        // locate button
        document.getElementById('locate-btn').addEventListener('click', getUserLocation);
        // try to get user location on load (optional; can be commented out)
        // getUserLocation();
    }

    // Get user's current location (same as before)
    function getUserLocation() {
        const statusDiv = document.getElementById('location-status');
        if (navigator.geolocation) {
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting your location...';
            navigator.geolocation.getCurrentPosition((position) => {
                const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                map.setCenter(userLocation);
                map.setZoom(8);
                if (userMarker) userMarker.setMap(null);
                userMarker = new google.maps.Marker({ position: userLocation, map: map, title: 'Your Location', icon: { url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' }, animation: google.maps.Animation.DROP });
                const iw = new google.maps.InfoWindow({ content: `<div style="padding:10px;"><h5>Your Location</h5><p>Lat: ${userLocation.lat.toFixed(6)}<br>Lng: ${userLocation.lng.toFixed(6)}</p></div>` });
                userMarker.addListener('click', () => iw.open(map, userMarker));
                iw.open(map, userMarker);
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Location found!';
                statusDiv.className = 'alert alert-success mt-3';
            }, (error) => { handleLocationError(error, statusDiv); });
        } else {
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Geolocation is not supported by your browser.';
            statusDiv.className = 'alert alert-danger mt-3';
        }
    }

    function handleLocationError(error, statusDiv){
        let errorMessage='';
        switch(error.code){
            case error.PERMISSION_DENIED: errorMessage='Location access denied.'; break;
            case error.POSITION_UNAVAILABLE: errorMessage='Location information is unavailable.'; break;
            case error.TIMEOUT: errorMessage='The request to get your location timed out.'; break;
            default: errorMessage='An unknown error occurred while getting your location.'; break;
        }
        statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMessage}`;
        statusDiv.className = 'alert alert-warning mt-3';
    }
</script>

<!-- Load Google Maps JavaScript API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>

<style>
    #map {
        border-radius: 8px;
    }
    
    .card {
        border: none;
        border-radius: 12px;
        overflow: hidden;
    }
    
    #locate-btn {
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 8px;
    }
    
    .alert {
        border-radius: 8px;
    }
</style>
{% endblock content %}
