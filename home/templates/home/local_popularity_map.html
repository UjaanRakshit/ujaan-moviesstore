{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Local Popularity Map</h1>
            <p class="lead">Discover popular movies in your area</p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
            <div class="alert alert-info mt-3" id="location-status">
                <i class="fas fa-info-circle"></i> Click the button below to center the map on your current location.
            </div>
            <button id="locate-btn" class="btn btn-primary mt-2">
                <i class="fas fa-location-arrow"></i> Use My Location
            </button>
        </div>
    </div>
</div>

<script>
    let map;
    let userMarker;

    // Initialize the map
    function initMap() {
        // Default location (centered on a neutral location)
        const defaultLocation = { lat: 40.7128, lng: -74.0060 }; // New York City as default

        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: defaultLocation,
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true,
        });

        // Info window for markers
        const infoWindow = new google.maps.InfoWindow();

        // Add click event to locate button
        document.getElementById("locate-btn").addEventListener("click", function() {
            getUserLocation();
        });

        // Automatically try to get user location on load
        getUserLocation();
    }

    // Get user's current location
    function getUserLocation() {
        const statusDiv = document.getElementById("location-status");

        if (navigator.geolocation) {
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting your location...';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };

                    // Center map on user's location
                    map.setCenter(userLocation);
                    map.setZoom(13);

                    // Remove existing marker if any
                    if (userMarker) {
                        userMarker.setMap(null);
                    }

                    // Add marker for user's location
                    userMarker = new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: "Your Location",
                        icon: {
                            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                        },
                        animation: google.maps.Animation.DROP,
                    });

                    // Add info window to marker
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px;">
                                <h5><i class="fas fa-map-marker-alt"></i> Your Location</h5>
                                <p>Latitude: ${userLocation.lat.toFixed(6)}<br>
                                Longitude: ${userLocation.lng.toFixed(6)}</p>
                                <p><em>This is where we'll show popular movies in future updates!</em></p>
                            </div>
                        `,
                    });

                    userMarker.addListener("click", () => {
                        infoWindow.open(map, userMarker);
                    });

                    // Automatically open info window
                    infoWindow.open(map, userMarker);

                    statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Location found! The map is now centered on your current location.';
                    statusDiv.className = 'alert alert-success mt-3';
                },
                (error) => {
                    handleLocationError(error, statusDiv);
                }
            );
        } else {
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Geolocation is not supported by your browser.';
            statusDiv.className = 'alert alert-danger mt-3';
        }
    }

    // Handle location errors
    function handleLocationError(error, statusDiv) {
        let errorMessage = '';

        switch(error.code) {
            case error.PERMISSION_DENIED:
                errorMessage = "Location access denied. Please enable location permissions in your browser.";
                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage = "Location information is unavailable.";
                break;
            case error.TIMEOUT:
                errorMessage = "The request to get your location timed out.";
                break;
            default:
                errorMessage = "An unknown error occurred while getting your location.";
                break;
        }

        statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMessage}`;
        statusDiv.className = 'alert alert-warning mt-3';
    }
</script>

<!-- Load Google Maps JavaScript API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>

<style>
    #map {
        border-radius: 8px;
    }

    .card {
        border: none;
        border-radius: 12px;
        overflow: hidden;
    }

    #locate-btn {
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 8px;
    }

    .alert {
        border-radius: 8px;
    }
</style>
{% endblock content %}
